{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "description": "Schema for Dagu configuration file (base.yaml). Configures server settings, authentication, paths, UI, services, and features.",
  "additionalProperties": false,
  "properties": {
    "host": {
      "type": "string",
      "description": "Server bind address."
    },
    "port": {
      "type": "integer",
      "description": "Server port number.",
      "minimum": 0,
      "maximum": 65535
    },
    "base_path": {
      "type": "string",
      "description": "Base path for the web UI (e.g., '/dagu')."
    },
    "api_base_path": {
      "type": "string",
      "description": "Base path for the API endpoints."
    },
    "api_base_url": {
      "type": "string",
      "description": "Deprecated: use api_base_path instead."
    },
    "headless": {
      "type": "boolean",
      "description": "Run in headless mode without the web UI."
    },
    "tls": {
      "$ref": "#/definitions/TLSDef"
    },
    "debug": {
      "type": "boolean",
      "description": "Enable debug mode with verbose logging."
    },
    "default_shell": {
      "type": "string",
      "description": "Default shell for executing commands (e.g., '/bin/bash')."
    },
    "log_format": {
      "type": "string",
      "description": "Log output format.",
      "enum": ["json", "text"]
    },
    "tz": {
      "type": "string",
      "description": "Timezone for scheduling and display (e.g., 'America/New_York')."
    },
    "auth": {
      "$ref": "#/definitions/AuthDef"
    },
    "permission_write_dags": {
      "type": "boolean",
      "description": "Deprecated: use permissions.write_dags instead. Allow writing DAG definitions."
    },
    "permission_run_dags": {
      "type": "boolean",
      "description": "Deprecated: use permissions.run_dags instead. Allow running DAGs."
    },
    "permissions": {
      "$ref": "#/definitions/PermissionsDef"
    },
    "dags": {
      "type": "string",
      "description": "Deprecated: use dags_dir or paths.dags_dir instead."
    },
    "dags_dir": {
      "type": "string",
      "description": "Directory containing DAG YAML files."
    },
    "executable": {
      "type": "string",
      "description": "Path to the dagu executable."
    },
    "log_dir": {
      "type": "string",
      "description": "Directory for log files."
    },
    "data_dir": {
      "type": "string",
      "description": "Directory for application data."
    },
    "suspend_flags_dir": {
      "type": "string",
      "description": "Directory for DAG suspend flag files."
    },
    "admin_logs_dir": {
      "type": "string",
      "description": "Directory for admin log files."
    },
    "base_config": {
      "type": "string",
      "description": "Path to the base configuration file."
    },
    "paths": {
      "$ref": "#/definitions/PathsDef"
    },
    "log_encoding_charset": {
      "type": "string",
      "description": "Deprecated: use ui.log_encoding_charset instead. Character encoding for log display."
    },
    "navbar_color": {
      "type": "string",
      "description": "Deprecated: use ui.navbar_color instead. Navigation bar color."
    },
    "navbar_title": {
      "type": "string",
      "description": "Deprecated: use ui.navbar_title instead. Navigation bar title."
    },
    "max_dashboard_page_limit": {
      "type": "integer",
      "description": "Deprecated: use ui.max_dashboard_page_limit instead. Maximum items per dashboard page.",
      "minimum": 1,
      "maximum": 1000
    },
    "latest_status_today": {
      "type": "boolean",
      "description": "Deprecated. Show only today's latest status on the dashboard."
    },
    "ui": {
      "$ref": "#/definitions/UIDef"
    },
    "peer": {
      "$ref": "#/definitions/PeerDef"
    },
    "remote_nodes": {
      "type": "array",
      "description": "List of remote node connections for distributed monitoring.",
      "items": {
        "$ref": "#/definitions/RemoteNodeDef"
      }
    },
    "coordinator": {
      "$ref": "#/definitions/CoordinatorDef"
    },
    "worker": {
      "$ref": "#/definitions/WorkerDef"
    },
    "scheduler": {
      "$ref": "#/definitions/SchedulerDef"
    },
    "queues": {
      "$ref": "#/definitions/QueueConfigDef"
    },
    "monitoring": {
      "$ref": "#/definitions/MonitoringDef"
    },
    "metrics": {
      "type": "string",
      "description": "Metrics endpoint visibility.",
      "enum": ["public", "private"]
    },
    "cache": {
      "type": "string",
      "description": "Cache level for performance tuning.",
      "enum": ["low", "normal", "high"]
    },
    "terminal": {
      "$ref": "#/definitions/TerminalDef"
    },
    "audit": {
      "$ref": "#/definitions/AuditDef"
    },
    "git_sync": {
      "$ref": "#/definitions/GitSyncDef"
    },
    "default_execution_mode": {
      "type": "string",
      "description": "Default execution mode for DAGs. 'local' runs DAGs on the server process, 'distributed' dispatches to workers.",
      "enum": ["local", "distributed"],
      "default": "local"
    },
    "tunnel": {
      "$ref": "#/definitions/TunnelDef"
    }
  },
  "definitions": {
    "TLSDef": {
      "type": "object",
      "description": "TLS/SSL encryption configuration.",
      "additionalProperties": false,
      "properties": {
        "cert_file": {
          "type": "string",
          "description": "Path to the TLS certificate file."
        },
        "key_file": {
          "type": "string",
          "description": "Path to the TLS private key file."
        },
        "ca_file": {
          "type": "string",
          "description": "Path to the CA certificate file for client verification."
        }
      }
    },
    "AuthDef": {
      "type": "object",
      "description": "Authentication configuration.",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "description": "Authentication mode.",
          "enum": ["none", "builtin", "oidc"]
        },
        "basic": {
          "$ref": "#/definitions/AuthBasicDef"
        },
        "token": {
          "$ref": "#/definitions/AuthTokenDef"
        },
        "oidc": {
          "$ref": "#/definitions/AuthOIDCDef"
        },
        "builtin": {
          "$ref": "#/definitions/AuthBuiltinDef"
        }
      }
    },
    "AuthBasicDef": {
      "type": "object",
      "description": "Basic authentication credentials.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable basic authentication."
        },
        "username": {
          "type": "string",
          "description": "Basic auth username."
        },
        "password": {
          "type": "string",
          "description": "Basic auth password."
        }
      }
    },
    "AuthTokenDef": {
      "type": "object",
      "description": "Token-based authentication configuration.",
      "additionalProperties": false,
      "properties": {
        "value": {
          "type": "string",
          "description": "Authentication token value."
        }
      }
    },
    "AuthOIDCDef": {
      "type": "object",
      "description": "OIDC authentication configuration. Core fields are used by both standalone and builtin auth modes.",
      "additionalProperties": false,
      "properties": {
        "client_id": {
          "type": "string",
          "description": "OAuth client identifier."
        },
        "client_secret": {
          "type": "string",
          "description": "OAuth client secret."
        },
        "client_url": {
          "type": "string",
          "description": "Application callback URL."
        },
        "issuer": {
          "type": "string",
          "description": "OIDC issuer URL."
        },
        "scopes": {
          "type": "array",
          "description": "OAuth scopes to request.",
          "items": {
            "type": "string"
          }
        },
        "whitelist": {
          "type": "array",
          "description": "Allowed email addresses.",
          "items": {
            "type": "string"
          }
        },
        "auto_signup": {
          "type": "boolean",
          "description": "Automatically create user accounts on first OIDC login. Default: true (builtin mode only)."
        },
        "allowed_domains": {
          "type": "array",
          "description": "Allowed email domains for OIDC login.",
          "items": {
            "type": "string"
          }
        },
        "button_label": {
          "type": "string",
          "description": "Label for the OIDC login button."
        },
        "role_mapping": {
          "$ref": "#/definitions/OIDCRoleMappingDef"
        }
      }
    },
    "OIDCRoleMappingDef": {
      "type": "object",
      "description": "Maps OIDC claims to Dagu roles.",
      "additionalProperties": false,
      "properties": {
        "default_role": {
          "type": "string",
          "description": "Default role assigned to users. Default: 'viewer'."
        },
        "groups_claim": {
          "type": "string",
          "description": "OIDC claim containing group information. Default: 'groups'."
        },
        "group_mappings": {
          "type": "object",
          "description": "Mapping of IdP group names to Dagu role names.",
          "additionalProperties": {
            "type": "string"
          }
        },
        "role_attribute_path": {
          "type": "string",
          "description": "jq expression for extracting role from OIDC claims."
        },
        "role_attribute_strict": {
          "type": "boolean",
          "description": "Deny login if no valid role is found via role mapping."
        },
        "skip_org_role_sync": {
          "type": "boolean",
          "description": "Only assign roles on first login, skip subsequent syncs."
        }
      }
    },
    "AuthBuiltinDef": {
      "type": "object",
      "description": "Builtin authentication with RBAC configuration.",
      "additionalProperties": false,
      "properties": {
        "admin": {
          "$ref": "#/definitions/AdminConfigDef"
        },
        "token": {
          "$ref": "#/definitions/TokenConfigDef"
        }
      }
    },
    "AdminConfigDef": {
      "type": "object",
      "description": "Initial admin user configuration.",
      "additionalProperties": false,
      "properties": {
        "username": {
          "type": "string",
          "description": "Admin username."
        },
        "password": {
          "type": "string",
          "description": "Admin password."
        }
      }
    },
    "TokenConfigDef": {
      "type": "object",
      "description": "JWT token settings.",
      "additionalProperties": false,
      "properties": {
        "secret": {
          "type": "string",
          "description": "JWT signing secret."
        },
        "ttl": {
          "type": "string",
          "description": "Token time-to-live duration (e.g., '24h')."
        }
      }
    },
    "PermissionsDef": {
      "type": "object",
      "description": "UI and API permissions.",
      "additionalProperties": false,
      "properties": {
        "write_dags": {
          "type": "boolean",
          "description": "Allow creating and editing DAG definitions."
        },
        "run_dags": {
          "type": "boolean",
          "description": "Allow executing DAG runs."
        }
      }
    },
    "PathsDef": {
      "type": "object",
      "description": "File system path configuration.",
      "additionalProperties": false,
      "properties": {
        "dags_dir": {
          "type": "string",
          "description": "Directory containing DAG YAML files."
        },
        "executable": {
          "type": "string",
          "description": "Path to the dagu executable."
        },
        "log_dir": {
          "type": "string",
          "description": "Directory for log files."
        },
        "data_dir": {
          "type": "string",
          "description": "Directory for application data."
        },
        "suspend_flags_dir": {
          "type": "string",
          "description": "Directory for DAG suspend flag files."
        },
        "admin_logs_dir": {
          "type": "string",
          "description": "Directory for admin log files."
        },
        "base_config": {
          "type": "string",
          "description": "Path to the base configuration file."
        },
        "dag_runs_dir": {
          "type": "string",
          "description": "Directory for DAG run history storage."
        },
        "queue_dir": {
          "type": "string",
          "description": "Directory for queue persistence."
        },
        "proc_dir": {
          "type": "string",
          "description": "Directory for process tracking files."
        },
        "service_registry_dir": {
          "type": "string",
          "description": "Directory for service discovery data."
        },
        "users_dir": {
          "type": "string",
          "description": "Directory for user data storage."
        },
        "api_keys_dir": {
          "type": "string",
          "description": "Directory for API key storage."
        },
        "webhooks_dir": {
          "type": "string",
          "description": "Directory for webhook configuration."
        },
        "sessions_dir": {
          "type": "string",
          "description": "Directory for session data storage."
        }
      }
    },
    "UIDef": {
      "type": "object",
      "description": "User interface configuration.",
      "additionalProperties": false,
      "properties": {
        "log_encoding_charset": {
          "type": "string",
          "description": "Character encoding for log display."
        },
        "navbar_color": {
          "type": "string",
          "description": "Navigation bar background color (CSS color value)."
        },
        "navbar_title": {
          "type": "string",
          "description": "Navigation bar title text."
        },
        "max_dashboard_page_limit": {
          "type": "integer",
          "description": "Maximum number of items per dashboard page.",
          "minimum": 1,
          "maximum": 1000
        },
        "dags": {
          "$ref": "#/definitions/DAGListDef"
        }
      }
    },
    "DAGListDef": {
      "type": "object",
      "description": "DAG list page configuration.",
      "additionalProperties": false,
      "properties": {
        "sort_field": {
          "type": "string",
          "description": "Field to sort DAGs by."
        },
        "sort_order": {
          "type": "string",
          "description": "Sort order for DAG list.",
          "enum": ["asc", "desc"]
        }
      }
    },
    "PeerDef": {
      "type": "object",
      "description": "TLS configuration for peer gRPC connections.",
      "additionalProperties": false,
      "properties": {
        "cert_file": {
          "type": "string",
          "description": "Path to the peer TLS certificate file."
        },
        "key_file": {
          "type": "string",
          "description": "Path to the peer TLS private key file."
        },
        "client_ca_file": {
          "type": "string",
          "description": "Path to the client CA certificate file."
        },
        "skip_tls_verify": {
          "type": "boolean",
          "description": "Skip TLS certificate verification."
        },
        "insecure": {
          "type": "boolean",
          "description": "Use h2c (HTTP/2 cleartext) instead of TLS."
        },
        "max_retries": {
          "type": "integer",
          "description": "Maximum number of connection retries. Default: 10."
        },
        "retry_interval": {
          "type": "string",
          "description": "Interval between connection retries. Default: '1s'."
        }
      }
    },
    "RemoteNodeDef": {
      "type": "object",
      "description": "Remote node connection configuration.",
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Display name for the remote node."
        },
        "api_base_url": {
          "type": "string",
          "description": "Base URL of the remote node's API."
        },
        "is_basic_auth": {
          "type": "boolean",
          "description": "Enable basic auth for this remote node."
        },
        "basic_auth_username": {
          "type": "string",
          "description": "Basic auth username for this remote node."
        },
        "basic_auth_password": {
          "type": "string",
          "description": "Basic auth password for this remote node."
        },
        "is_auth_token": {
          "type": "boolean",
          "description": "Enable token auth for this remote node."
        },
        "auth_token": {
          "type": "string",
          "description": "Auth token for this remote node."
        },
        "skip_tls_verify": {
          "type": "boolean",
          "description": "Skip TLS certificate verification for this remote node."
        }
      }
    },
    "CoordinatorDef": {
      "type": "object",
      "description": "Coordinator service configuration for distributed execution.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable the coordinator service for distributed execution. Default: true."
        },
        "host": {
          "type": "string",
          "description": "Coordinator bind address."
        },
        "advertise": {
          "type": "string",
          "description": "Advertised address for workers to connect to. Auto-detected if empty."
        },
        "port": {
          "type": "integer",
          "description": "Coordinator port number.",
          "minimum": 0,
          "maximum": 65535
        }
      }
    },
    "WorkerDef": {
      "type": "object",
      "description": "Worker process configuration for distributed execution.",
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique worker identifier."
        },
        "max_active_runs": {
          "type": "integer",
          "description": "Maximum concurrent DAG runs for this worker."
        },
        "labels": {
          "oneOf": [
            {
              "type": "string",
              "description": "Comma-separated key=value pairs (e.g., 'env=prod,region=us')."
            },
            {
              "type": "object",
              "description": "Key-value map of worker labels.",
              "additionalProperties": {
                "type": "string"
              }
            }
          ],
          "description": "Worker labels for selective execution. Accepts a comma-separated string or an object."
        },
        "coordinators": {
          "oneOf": [
            {
              "type": "string",
              "description": "Single coordinator URL."
            },
            {
              "type": "array",
              "description": "List of coordinator URLs.",
              "items": {
                "type": "string"
              }
            }
          ],
          "description": "Coordinator address(es) to connect to. Accepts a single string or an array."
        },
        "postgres_pool": {
          "$ref": "#/definitions/PostgresPoolDef"
        }
      }
    },
    "PostgresPoolDef": {
      "type": "object",
      "description": "PostgreSQL connection pool configuration.",
      "additionalProperties": false,
      "properties": {
        "max_open_conns": {
          "type": "integer",
          "description": "Maximum number of open connections. Default: 25."
        },
        "max_idle_conns": {
          "type": "integer",
          "description": "Maximum number of idle connections. Default: 5."
        },
        "conn_max_lifetime": {
          "type": "integer",
          "description": "Maximum connection lifetime in seconds. Default: 300."
        },
        "conn_max_idle_time": {
          "type": "integer",
          "description": "Maximum idle time in seconds. Default: 60."
        }
      }
    },
    "SchedulerDef": {
      "type": "object",
      "description": "Scheduler service configuration.",
      "additionalProperties": false,
      "properties": {
        "port": {
          "type": "integer",
          "description": "Scheduler port number.",
          "minimum": 0,
          "maximum": 65535
        },
        "lock_stale_threshold": {
          "type": "string",
          "description": "Duration after which a lock is considered stale. Default: '30s'."
        },
        "lock_retry_interval": {
          "type": "string",
          "description": "Interval between lock retry attempts. Default: '5s'."
        },
        "zombie_detection_interval": {
          "type": "string",
          "description": "Interval for detecting zombie processes. Default: '45s'. Set to '0' to disable."
        }
      }
    },
    "QueueConfigDef": {
      "type": "object",
      "description": "Global queue configuration.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable the queue system."
        },
        "config": {
          "type": "array",
          "description": "List of queue definitions.",
          "items": {
            "$ref": "#/definitions/QueueDef"
          }
        }
      }
    },
    "QueueDef": {
      "type": "object",
      "description": "Individual queue configuration.",
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Queue name."
        },
        "max_active_runs": {
          "type": "integer",
          "description": "Deprecated: use max_concurrency instead."
        },
        "max_concurrency": {
          "type": "integer",
          "description": "Maximum concurrent runs for this queue."
        }
      }
    },
    "MonitoringDef": {
      "type": "object",
      "description": "System monitoring configuration.",
      "additionalProperties": false,
      "properties": {
        "retention": {
          "type": "string",
          "description": "Monitoring data retention duration. Default: '24h'."
        },
        "interval": {
          "type": "string",
          "description": "Monitoring data collection interval. Default: '5s'."
        }
      }
    },
    "TerminalDef": {
      "type": "object",
      "description": "Web-based terminal feature configuration.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable the web-based terminal. Default: false."
        }
      }
    },
    "AuditDef": {
      "type": "object",
      "description": "Audit logging feature configuration.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable audit logging. Default: true."
        },
        "retention_days": {
          "type": "integer",
          "description": "Number of days to retain audit logs. Default: 7."
        }
      }
    },
    "GitSyncDef": {
      "type": "object",
      "description": "Git synchronization configuration for DAG definitions.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable Git sync. Default: false."
        },
        "repository": {
          "type": "string",
          "description": "Git repository URL."
        },
        "branch": {
          "type": "string",
          "description": "Git branch to sync. Default: 'main'."
        },
        "path": {
          "type": "string",
          "description": "Subdirectory within the repository. Empty for root."
        },
        "auth": {
          "$ref": "#/definitions/GitSyncAuthDef"
        },
        "auto_sync": {
          "$ref": "#/definitions/GitSyncAutoSyncDef"
        },
        "push_enabled": {
          "type": "boolean",
          "description": "Enable pushing changes back to the repository. Default: true."
        },
        "commit": {
          "$ref": "#/definitions/GitSyncCommitDef"
        }
      }
    },
    "GitSyncAuthDef": {
      "type": "object",
      "description": "Git authentication configuration.",
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "description": "Authentication type.",
          "enum": ["token", "ssh"]
        },
        "token": {
          "type": "string",
          "description": "Git access token."
        },
        "ssh_key_path": {
          "type": "string",
          "description": "Path to SSH private key file."
        },
        "ssh_passphrase": {
          "type": "string",
          "description": "Passphrase for the SSH key."
        }
      }
    },
    "GitSyncAutoSyncDef": {
      "type": "object",
      "description": "Automatic Git synchronization configuration.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable automatic sync. Default: false."
        },
        "on_startup": {
          "type": "boolean",
          "description": "Sync on application startup. Default: true."
        },
        "interval": {
          "type": "integer",
          "description": "Sync interval in seconds. Default: 300."
        }
      }
    },
    "GitSyncCommitDef": {
      "type": "object",
      "description": "Git commit metadata configuration.",
      "additionalProperties": false,
      "properties": {
        "author_name": {
          "type": "string",
          "description": "Commit author name. Default: 'Dagu'."
        },
        "author_email": {
          "type": "string",
          "description": "Commit author email. Default: 'dagu@localhost'."
        }
      }
    },
    "TunnelDef": {
      "type": "object",
      "description": "Tunnel service configuration for remote access.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable tunnel service. Default: false."
        },
        "tailscale": {
          "$ref": "#/definitions/TailscaleTunnelDef"
        },
        "allow_terminal": {
          "type": "boolean",
          "description": "Allow terminal access through tunnel. Default: false."
        },
        "allowed_ips": {
          "type": "array",
          "description": "IP addresses allowed through the tunnel. Empty allows all.",
          "items": {
            "type": "string"
          }
        },
        "rate_limiting": {
          "$ref": "#/definitions/TunnelRateLimitDef"
        }
      }
    },
    "TailscaleTunnelDef": {
      "type": "object",
      "description": "Tailscale tunnel configuration.",
      "additionalProperties": false,
      "properties": {
        "auth_key": {
          "type": "string",
          "description": "Tailscale authentication key."
        },
        "hostname": {
          "type": "string",
          "description": "Tailscale hostname. Default: 'dagu'."
        },
        "funnel": {
          "type": "boolean",
          "description": "Enable Tailscale Funnel for public internet access."
        },
        "https": {
          "type": "boolean",
          "description": "Enable HTTPS for tailnet-only access."
        },
        "state_dir": {
          "type": "string",
          "description": "Tailscale state directory. Default: '$DAGU_HOME/tailscale'."
        }
      }
    },
    "TunnelRateLimitDef": {
      "type": "object",
      "description": "Rate limiting for tunnel authentication endpoints.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable rate limiting."
        },
        "login_attempts": {
          "type": "integer",
          "description": "Maximum login attempts within the window. Default: 5."
        },
        "window_seconds": {
          "type": "integer",
          "description": "Rate limit window duration in seconds. Default: 300."
        },
        "block_duration_seconds": {
          "type": "integer",
          "description": "Duration to block after exceeding limit in seconds. Default: 900."
        }
      }
    }
  }
}
