# Example production Docker Compose setup for Boltbase with OpenTelemetry, Prometheus, and Grafana
version: "3.9"

services:
  # OpenTelemetry stack for tracing (from docs/features/opentelemetry-testing.md)
  jaeger:
    image: jaegertracing/all-in-one:latest
    networks: [boltbase-net]
    ports:
      - "16686:16686" # Jaeger UI
      - "14250:14250" # gRPC ingest

  otel-collector:
    image: otel/opentelemetry-collector:latest
    command: ["--config=/etc/otel-collector.yaml"]
    volumes:
      - ./otel-collector.yaml:/etc/otel-collector.yaml:ro
    ports:
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
    depends_on:
      - jaeger
    networks: [boltbase-net]

  # Prometheus: scrapes metrics from OTel Collector and Boltbase server
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yaml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      - otel-collector
      - boltbase-server
    networks: [boltbase-net]

  # Boltbase control-plane: Coordinator (gRPC) for distributed workers
  boltbase-coordinator:
    image: ghcr.io/dagu-org/boltbase:latest
    command: ["boltbase", "coordinator"]
    environment:
      # Peer config: insecure by default; set TLS envs if needed
      - BOLTBASE_PEER_INSECURE=true
      # Bind and advertise on container IP/DNS so workers can reach it
      - BOLTBASE_COORDINATOR_HOST=boltbase-coordinator
      - BOLTBASE_COORDINATOR_PORT=50055
    ports:
      - "50055:50055"
    volumes:
      - boltbase-data:/var/lib/boltbase
      - ./dags:/var/lib/boltbase/dags:ro
    networks: [boltbase-net]

  # Boltbase scheduler service (reads DAGs and enqueues runs)
  boltbase-scheduler:
    image: ghcr.io/dagu-org/boltbase:latest
    command: ["boltbase", "scheduler"]
    environment:
      - BOLTBASE_COORDINATOR_HOST=boltbase-coordinator
      - BOLTBASE_COORDINATOR_PORT=50055
      - BOLTBASE_SCHEDULER_PORT=8090
      - BOLTBASE_DAGS_DIR=/var/lib/boltbase/dags
      # Optional: set timezone, logging, etc
      # - BOLTBASE_TZ=UTC
      # - BOLTBASE_LOG_FORMAT=json
    depends_on:
      - boltbase-coordinator
    ports:
      - "8090:8090" # Scheduler health
    volumes:
      - boltbase-data:/var/lib/boltbase
      - ./dags:/var/lib/boltbase/dags:ro
    networks: [boltbase-net]

  # Boltbase web UI / API server
  boltbase-server:
    image: ghcr.io/dagu-org/boltbase:latest
    command: ["boltbase", "server"]
    environment:
      - BOLTBASE_COORDINATOR_HOST=boltbase-coordinator
      - BOLTBASE_COORDINATOR_PORT=50055
      - BOLTBASE_HOST=0.0.0.0
      - BOLTBASE_PORT=8080
      - BOLTBASE_DAGS_DIR=/var/lib/boltbase/dags
      # Builtin authentication (RBAC) - CHANGE TOKEN_SECRET IN PRODUCTION
      - BOLTBASE_AUTH_MODE=builtin
      - BOLTBASE_AUTH_TOKEN_SECRET=CHANGE_ME_TO_A_SECURE_RANDOM_STRING
      # Admin credentials: password auto-generated on first run, printed to stdout
      # - BOLTBASE_AUTH_ADMIN_USERNAME=admin # default is 'admin'
      # - BOLTBASE_AUTH_ADMIN_PASSWORD=      # set to use a specific password
      # - BOLTBASE_AUTH_TOKEN_TTL=24h        # default is 24h
      # If behind a proxy, set base path
      # - BOLTBASE_BASE_PATH=/boltbase
    depends_on:
      - boltbase-scheduler
      - boltbase-coordinator
    ports:
      - "8080:8080"
    volumes:
      - boltbase-data:/var/lib/boltbase
      - ./dags:/var/lib/boltbase/dags:ro
    networks: [boltbase-net]

  # Boltbase worker (polls coordinator and executes tasks)
  boltbase-worker:
    image: ghcr.io/dagu-org/boltbase:latest
    command: ["boltbase", "worker"]
    environment:
      - BOLTBASE_COORDINATOR_HOST=boltbase-coordinator
      - BOLTBASE_COORDINATOR_PORT=50055
      # Optional worker tuning and labels
      # - BOLTBASE_WORKER_MAX_ACTIVE_RUNS=100
      # - BOLTBASE_WORKER_LABELS=region=us-east-1,instance-type=m5.large
      # OTel: point DAGs to collector via per-DAG otel.endpoint: "otel-collector:4317"
    depends_on:
      - boltbase-coordinator
    volumes:
      - boltbase-data:/var/lib/boltbase
      # Workers typically don't need DAG definitions, but sharing is harmless
      - ./dags:/var/lib/boltbase/dags:ro
    networks: [boltbase-net]

  # Grafana: visualize Prometheus metrics
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    networks: [boltbase-net]

volumes:
  boltbase-data:
    driver: local
  grafana-data:
    driver: local

networks:
  boltbase-net:
    driver: bridge
